{extend name="common/base" /}
{block name="content"}
<div class="row">
	<div class="col-md-12">
		<div class="card">
			<div class="card-header">
				<header class="card-title">
					{:__('speedCache')}
				</header>
			</div>
			<div class="card-body" id="load_status">
				<table class="table table-bordered">
					<thead>
						<tr>
							<th colspan="3">{:__('Status')}：
								{if $status }
									<span style="color:green" >{:__('Open')}<a href="javascript:speed_cache_status('close');">[{:__('Close')}]</a></span>
									{else /}
									<span style="color:#2288cc" >{:__('Close')}<a href="javascript:speed_cache_status('open');">[{:__('Open')}]</a></span>
								{/if}
							</th>
						</tr>
					</thead>
					<tbody>
						<tr>
							<td style="text-align: center;">{:__('Today Hit')}</td>
							<td style="text-align: center;">{:__('Total Hit')}</td>
							<td style="text-align: center;">{:__('Acceleration strategy')}</td>
						</tr>
						<tr>
							<td style="text-align: center;">{$today_hit|default="0"} %</td>
							<td style="text-align: center;">{$total_hit|default="0"} %</td>
							<td style="text-align: center;" onclick="cache_list()"><span class="btn btn-sm btn-info btn-block">{$rule|default="Default"}</span></td>
						</tr>
					</tbody>
				</table>
				<hr>
				<small class="text-muted">
					<span style="color:red"></span> {:__('If your site does not allow anonymous access, please do not enable site acceleration')}<br>
					<span style="color:red"></span> {:__('If your site is an interactive site, the hit rate may be low')}<br>
					<span style="color:red">！</span> {:__('After enabling site acceleration, if site acceleration is found, please turn off site acceleration')}<br>
					<span style="color:red">！</span> {:__('After enabling site acceleration, the update frequency of your website page content depends on the [Cache Period] time')}<br>
				</small>
			</div>
		</div>
	</div>
</div>
{/block}
{block name="script"}
<script>
    function speed_cache_status(type){
		var l = $('#load_status').lyearloading({
			opacity: 0.125,
			spinnerSize: 'lg'
		});
		$.post('', {
			status: type
		}, function (res) {
			EchoMsg(res.msg, 1);
		})
		.fail(function () {
			EchoMsg('{:__("Request error, please try again later")}');
		})
		.always(function () {
			l.destroy();
		})
    }

	function cache_list(){
		var l = $('#load_status').lyearloading({
			opacity: 0.125,
			spinnerSize: 'lg'
		});
		$.post('{:url("index/vhost/speed_cache_list")}', '', function (res) {
			if(res){
				var list_content = '';
				$.each(res,function(i,v){
					list_content+='<tr>';
					list_content+= '<td>'+v.name+'</td>';
					list_content+= '<td>'+v.ps+'</td>';
					list_content+= '<td><a class="btn btn-sm btn-success" onclick="set_rule(\''+v.name+'\')">{:__("Apply")}</a></td>';
					list_content+='</tr>';
				});
				content = '<div class="row"><div class="col-lg-12"><table class="table"><tbody class="rule_list">'+list_content+'</tbody></table></div></div>';
				$.alert({
					title: '内置规则列表',
					boxWidth: [$(window).width() > 800 ? '800px' : '60%', $(window).height() > 600 ? '600px' : '95%'],
					content: content,
					animation: 'scale',
					closeAnimation: 'bottom',
					backgroundDismiss: true,
					draggable: true,
					icon: 'mdi mdi-rocket',
				});
			}
		})
		.fail(function () {
			EchoMsg('{:__("Request error, please try again later")}');
		})
		.always(function () {
			l.destroy();
		})
	}

	function set_rule(name){
		var l = $('.jconfirm-box').lyearloading({
			opacity: 0.125,
			spinnerSize: 'lg'
		});
		$.post('', {
			ruleName:name,
		}, function (res) {
			EchoMsg(res.msg, res.code);
		})
		.fail(function () {
			EchoMsg('{:__("Request error, please try again later")}');
		})
		.always(function () {
			l.destroy();
		})
	}
</script>
{/block}