{extend name="common/base" /}
{block name="css"}
<style type="text/css">
    .cm-s-default {
        height: 100% !important;
    }

    /*.CodeMirror pre{
        padding-left: 25px !important;
    }*/
    /*分片上传css*/
    #file_input {
        display: none;
    }

    #up_box {
        background-color: #fafbfe;
        border: #e4e5e9 1px solid;
        margin: 0;
        padding: 10px;
        clear: both;
        height: 360px;
        overflow: auto;
    }

    #up_box li {
        list-style-type: none;
        height: 30px;
        line-height: 30px;
        font-size: 12px;
        width: 100%;
        margin: 0 0 5px;
        padding: 0;
    }

    #up_box li .filename {
        display: inline-block;
        height: 30px;
        margin-right: 20px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        width: 240px;
    }

    #up_box li .filesize {
        color: #999;
        display: inline-block;
        height: 30px;
        overflow: hidden;
    }

    #up_box li em {
        font-style: normal;
        color: #06F;
        float: right;
        margin-right: 10px;
    }

    #totalProgress progress {
        width: 180px;
        height: 10px;
        border: 1px solid #ccc;
        background-color: #e6e6e6;
        color: #0064b4;
        opacity: .9;
    }

    .layui-layer-content {
        padding: 10px;
    }
    .text-middle{
        vertical-align:middle;
    }
</style>
{/block}
{block name="content"}
<link href="__CDN____STATIC/Light-Year/css/animate.min.css" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="/assets/libs/codemirror/lib/codemirror.css">
<script type="text/javascript" src="/assets/libs/codemirror/lib/codemirror.js"></script>
<script type="text/javascript" src="/assets/libs/codemirror/addon/scroll/annotatescrollbar.js"></script>

<!-- <script type="text/javascript" src="/assets/libs/codemirror/addon/edit/editAll.js"></script> -->
<!-- <script type="text/javascript" src="/assets/libs/codemirror/mode/modeAll.js"></script> -->
<!-- 引入javascript编辑器格式 -->
<script src="/assets/libs/codemirror/mode/clike/clike.js"></script>
<script src="/assets/libs/codemirror/mode/htmlmixed/htmlmixed.js"></script>
<!-- <script src="/assets/libs/codemirror/mode/javascript/javascript.js"></script> -->
<!-- <script src="/assets/libs/codemirror/mode/php/php.js"></script> -->
<!-- <script src="/assets/libs/codemirror/mode/shell/shell.js"></script>
<script src="/assets/libs/codemirror/mode/python/python.js"></script>
<script src="/assets/libs/codemirror/mode/nginx/nginx.js"></script>
<script src="/assets/libs/codemirror/mode/markdown/markdown.js"></script>
 -->
<script type="text/javascript" src="/assets/libs/codemirror/addon/dialog/dialog.js"></script>
<script type="text/javascript" src="/assets/libs/codemirror/addon/search/search.js"></script>
<!-- 各种主题配色 -->
<link rel="stylesheet" href="/assets/libs/codemirror/theme/monokai.css">
<link rel="stylesheet" href="/assets/libs/codemirror/theme/3024-day.css">
<link rel="stylesheet" href="/assets/libs/codemirror/theme/3024-night.css">
<link rel="stylesheet" href="/assets/libs/codemirror/theme/abcdef.css">
<link rel="stylesheet" href="/assets/libs/codemirror/theme/ambiance.css">
<link rel="stylesheet" href="/assets/libs/codemirror/theme/base16-dark.css">
<link rel="stylesheet" href="/assets/libs/codemirror/theme/bespin.css">
<link rel="stylesheet" href="/assets/libs/codemirror/theme/base16-light.css">
<link rel="stylesheet" href="/assets/libs/codemirror/theme/blackboard.css">
<link rel="stylesheet" href="/assets/libs/codemirror/theme/cobalt.css">
<link rel="stylesheet" href="/assets/libs/codemirror/theme/colorforth.css">
<link rel="stylesheet" href="/assets/libs/codemirror/theme/dracula.css">
<link rel="stylesheet" href="/assets/libs/codemirror/theme/duotone-dark.css">
<link rel="stylesheet" href="/assets/libs/codemirror/theme/duotone-light.css">
<link rel="stylesheet" href="/assets/libs/codemirror/theme/eclipse.css">
<link rel="stylesheet" href="/assets/libs/codemirror/theme/elegant.css">
<link rel="stylesheet" href="/assets/libs/codemirror/theme/erlang-dark.css">
<link rel="stylesheet" href="/assets/libs/codemirror/theme/hopscotch.css">
<link rel="stylesheet" href="/assets/libs/codemirror/theme/icecoder.css">
<link rel="stylesheet" href="/assets/libs/codemirror/theme/isotope.css">
<link rel="stylesheet" href="/assets/libs/codemirror/theme/lesser-dark.css">
<link rel="stylesheet" href="/assets/libs/codemirror/theme/liquibyte.css">
<link rel="stylesheet" href="/assets/libs/codemirror/theme/material.css">
<link rel="stylesheet" href="/assets/libs/codemirror/theme/mbo.css">
<link rel="stylesheet" href="/assets/libs/codemirror/theme/mdn-like.css">
<link rel="stylesheet" href="/assets/libs/codemirror/theme/midnight.css">
<link rel="stylesheet" href="/assets/libs/codemirror/theme/monokai.css">
<link rel="stylesheet" href="/assets/libs/codemirror/theme/neat.css">
<link rel="stylesheet" href="/assets/libs/codemirror/theme/neo.css">
<link rel="stylesheet" href="/assets/libs/codemirror/theme/night.css">
<link rel="stylesheet" href="/assets/libs/codemirror/theme/panda-syntax.css">
<link rel="stylesheet" href="/assets/libs/codemirror/theme/paraiso-dark.css">
<link rel="stylesheet" href="/assets/libs/codemirror/theme/paraiso-light.css">
<link rel="stylesheet" href="/assets/libs/codemirror/theme/pastel-on-dark.css">
<link rel="stylesheet" href="/assets/libs/codemirror/theme/railscasts.css">
<link rel="stylesheet" href="/assets/libs/codemirror/theme/rubyblue.css">
<link rel="stylesheet" href="/assets/libs/codemirror/theme/seti.css">
<link rel="stylesheet" href="/assets/libs/codemirror/theme/solarized.css">
<link rel="stylesheet" href="/assets/libs/codemirror/theme/the-matrix.css">
<link rel="stylesheet" href="/assets/libs/codemirror/theme/tomorrow-night-bright.css">
<link rel="stylesheet" href="/assets/libs/codemirror/theme/tomorrow-night-eighties.css">
<link rel="stylesheet" href="/assets/libs/codemirror/theme/ttcn.css">
<link rel="stylesheet" href="/assets/libs/codemirror/theme/twilight.css">
<link rel="stylesheet" href="/assets/libs/codemirror/theme/vibrant-ink.css">
<link rel="stylesheet" href="/assets/libs/codemirror/theme/xq-dark.css">
<link rel="stylesheet" href="/assets/libs/codemirror/theme/xq-light.css">
<link rel="stylesheet" href="/assets/libs/codemirror/theme/yeti.css">
<link rel="stylesheet" href="/assets/libs/codemirror/theme/zenburn.css">
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body example-box">
                <button style="float: right;" class="btn btn-sm btn-success" onclick="location.reload()" title="刷新"><i class="mdi mdi-restore"></i></button>
                <button style="float: right;" class="btn btn-sm btn-dark" onclick="newdir()">新建目录</button>
                <button style="float: right;" class="btn btn-sm btn-purple" onclick="newfile()">新建文件</button>
                <!-- <button style="float: right;" class="btn btn-sm btn-info" onclick="UploadFiles()">上传</button> -->
                <div class="batchAction" style="display: none;">
                    <button style="float: right;" class="btn btn-sm btn-info" onclick="batchAction('CutFiles')">复制</button>
                    <button style="float: right;" class="btn btn-sm btn-info" onclick="batchAction('CutFile')">剪切</button>
                    <button style="float: right;" class="btn btn-sm btn-info" onclick="batchAction('del')">删除</button>
                </div>
                
                <form id="btyUploadFile">
                    <div class="upload-drag" id="upload-drag" onclick="zunfile.click()" title="点击上传文件" style="float: right;">
                        <input type="hidden" name="type" value="uploadfile">
                        <p id="stat" class="btn btn-sm btn-info">上传文件</p>
                        <input type="file" id="zunfile" name="zunfile" onchange="scs();" style="display:none" accept="*/*">
                    </div>
                </form>
                <div style="float: left;padding-left: 10px;padding-top:5px;">
                    当前目录：
                    <a href="?path=/" class="loading_dir">
                        根目录
                    </a>
                    {volist name="paths" id="path"}
                    / <a href="?path={$path.url}" class="loading_dir">{$path.path}</a>
                    {/volist}
                    {if cookie('cutFileName')}
                    <a href="javascript:PasteFile('{$viewpath}');">粘贴</a>
                    {elseif cookie('copyFileName')}
                    <a href="javascript:PasteFile('{$viewpath}',1);">粘贴</a>
                    {elseif cookie('cutFileNames')}
                    <a href="javascript:PasteFiles('{$viewpath}');">粘贴</a>
                    {elseif cookie('copyFileNames')}
                    <a href="javascript:PasteFiles('{$viewpath}',1);">粘贴</a>
                    {/if}
                </div>

                <div class="table-responsive" style="clear: both;">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <td>
                            <label class="lyear-checkbox checkbox-primary">
                                <input type="checkbox" id="check-all"><span></span>
                            </label>
                        </td>
                        <td>
                            文件名
                        </td>
                        <td>
                            大小
                        </td>
                        <td>
                            修改时间
                        </td>
                        <td>
                            权限
                        </td>
                        <td>
                            所有者
                        </td>
                        <td>
                            操作
                        </td>
                    </tr>
                </thead>
                <tbody>
                    {volist name="list.dirs" id="dirs"}
                    <tr>
                        <td>
                            <label class="lyear-checkbox checkbox-primary">
                                <input type="checkbox" name="ids[]" value="{$key}"><span></span>
                            </label>
                        </td>
                        <td><span class="mdi mdi-folder text-warning mdi-24px text-middle"></span> <a href="?path={$viewpath}{$dirs.name}">{$dirs.name}</a></td>
                        <td><a href="javascript:;" onclick="getSize('{$dirs.name}',this)">计算大小</a></td>
                        <td>{:monthTosmonth($dirs.month)}-{$dirs.day} {$dirs.time}</td>
                        <td>{$dirs.chmod}</td>
                        <td>{$dirs.group}</td>
                        <td>
                            <span>
                            	
                                <a class="btlink" href="javascript:CutFile('{$viewpath}{$key}','{$key}');">
                                    剪切
                                </a>
                                |
                                <a class="btlink" href="javascript:MvFile('{$key}');">
                                    重命名
                                </a>
                                |
                                <a class="btlink" href="javascript:;" onclick="DeleteDir('{$viewpath}{$key}')">
                                    删除
                                </a>
                            </span>
                        </td>
                    </tr>
                    {/volist}
                    {volist name="list.files" id="files"}
                    {if $files.group=='www'&&$files.name!='.user.ini'}
                    <tr>
                        <td>
                            <label class="lyear-checkbox checkbox-primary">
                                <input type="checkbox" name="ids[]" value="{$key}"><span></span>
                            </label>
                        </td>
                        <td>
                            <?php
                            switch (fileExtension($files['name'])) {
                                case 'bmp':
                                case 'gif':
                                case 'png':
                                case 'jpeg':
                                case 'jpg':
                                case 'tiff':
                                case 'ico':
                                ?>
                                <span class="mdi mdi-file-image text-primary mdi-24px text-middle"></span>
                                <?php 
                                break;
                                case 'zip':
                                case 'rar':
                                case 'gz':
                                case '7z':
                                case 'rar':
                                case 'gz':
                                ?>
                                <span class="mdi mdi-zip-box text-warning mdi-24px text-middle"></span>
                                <?php 
                                break;
                                case 'sql':
                                ?>
                                <span class="mdi mdi-database text-danger mdi-24px text-middle"></span>
                                <?php 
                                break;
                                case 'txt':
                                ?>
                                <span class="mdi mdi-file-document text-gray mdi-24px text-middle"></span>
                                <?php 
                                break;
                                case 'php':
                                ?>
                                <span class="mdi mdi-file-code text-cyan mdi-24px text-middle"></span>
                                <?php 
                                break;
                                case 'html':
                                ?>
                                <span class="mdi mdi-language-html5 text-info mdi-24px text-middle"></span>
                                <?php 
                                break;
                            default:
                                ?>
                                <span class="mdi mdi-file text-secondary mdi-24px text-middle"></span>
                                <?php 
                                    break;
                            }
                            ?>
                            {$files.name}
                        </td>
                        <td>{:formatBytes($files.size)}</td>
                        <td>{:monthTosmonth($files.month)}-{$files.day} {notempty name="dirs.time"} {$dirs.time}{/notempty}</td>
                        <td>{$files.chmod}</td>
                        <td>{$files.group}</td>
                        <td>
                            <span id="operation">
                                <a class="btlink" href="javascript:CutFile('{$viewpath}{$key}','{$key}',1);">
                                    复制
                                </a>
                                |
                                <a class="btlink" href="javascript:CutFile('{$viewpath}{$key}','{$key}');">
                                    剪切
                                </a>
                                |
                                <a class="btlink" href="javascript:MvFile('{$key}');">
                                    重命名
                                </a>
                                <?php 
                                switch (fileExtension($files['name'])) {
                                case 'bmp':
                                case 'gif':
                                case 'png':
                                case 'jpeg':
                                case 'jpg':
                                case 'tiff':
                                case 'ico':
                                
                                break;
                                case 'zip':
                                case 'rar':
                                case 'gz':
                                case '7z':
                                case 'rar':
                                case 'gz':
                                break;

                                case 'sql':
                                default:
                                ?>
                                |
                                <a class="btlink" href="javascript:;" onclick="editFile('{$viewpath}{$key}','{:fileExtension($files['name'])}')">
                                    编辑
                                </a>
                                <?php
                                break;
                            }?>
                                |
                                <a class="btlink" href="{:url('index/vhost/file_ftp')}?go=1&downfile={$viewpath}{$key}" target="_blank">
                                    下载
                                </a>
                                |
                                <a class="btlink" href="javascript:;" onclick="DeleteFile('{$viewpath}{$key}')">
                                    删除
                                </a>
                            </span>
                        </td>
                    </tr>
                    {/if}
                    {/volist}
                </tbody>
            </table>
            </div>
        </div>
    </div>
</div>
</div>
{/block}
{block name="script"}
<script src="/assets/libs/layer/layer.js"></script>
<script type="text/javascript" src="__CDN____STATIC/Light-Year/js/bootstrap-notify.min.js"></script>
<script type="text/javascript">
    function DeleteFile(file){
        if(!file){
            layer.msg('请选择文件');
            return false;
        }
        layer.confirm('确定删除？', {
              btn: ['确定','取消']
            }, function(){
              $.post('', {type:'deletefile',file:file}, function(data, textStatus, xhr) {
                    EchoMsg(data.msg);
                });
            }, function(index){
              layer.close(index);
        });
        
    }
    function sqlInput(file){
        if(!file){
            layer.msg('请选择文件');
            return false;
        }
        layer.confirm('确定要导入数据库？导入会覆盖之前的数据哦~！', {
              btn: ['确定','取消']
            }, function(){
              $.post('', {type:'sqlinput',file:file}, function(data, textStatus, xhr) {
                    EchoMsg(data.msg);
                });
            }, function(index){
              layer.close(index);
        });
        
    }
    function DeleteDir(file){
        if(!file){
            layer.msg('请选择文件夹');
            return false;
        }
        layer.confirm('确定删除？', {
              btn: ['确定','取消']
            }, function(){
              $.post('', {type:'deletedir',file:file}, function(data, textStatus, xhr) {
            EchoMsg(data.msg);
        });
            }, function(index){
              layer.close(index);
        });
        
    }

    function isZip(fileName){
        if(!fileName){
            return false;
        }
        var ext = fileName.split('.');
        var extName = ext[ext.length-1].toLowerCase();
        if( extName == 'zip' || extName == 'rar') return 0;
        if( extName == 'gz' || extName == 'tgz') return 1;
        return -1;
    }
    
    function MvFile(file){
        if(!file){
            layer.msg('请选择文件');
            return false;
        }
        path = '{$viewpath}';
          layer.prompt({title: '重命名', formType: 3,value:file}, function(text, index){
            layer.close(index);
            $.post('', {type:'MvFile',path: path,oldName:file,newName:text}, function(data, textStatus, xhr) {
                EchoMsg(data.msg);
            });
          });
    }
    function getSize(path,obj){
        if(!path){
            layer.msg('请选择文件');
            return false;
        }
        layer.msg('Loading……');
        $.post('', {path:path,type:'getsize'}, function(data, textStatus, xhr) {
            console.log(obj);
            obj.innerHTML = data.msg;
        });

    }
    function CutFile(file,name='',copy=''){
        if(!file){
            layer.msg('请选择文件');
            return false;
        }
        $.post('', {file: file,type:'cut',name:name,copy:copy}, function(data, textStatus, xhr) {
            layer.msg(data.msg);
        });
    }
    function PasteFile(path,copy){
        if(!path){
            layer.msg('请选择粘贴文件');
            return false;
        }
        layer.load(2);
        $.post('', {type: 'paste',path:path,copy:copy}, function(data, textStatus, xhr) {
        	layer.closeAll('loading');
            layer.msg(data.msg);
        });
    }
    function PasteFiles(path,copy){
        if(!path){
            layer.msg('请选择粘贴文件');
            return false;
        }
        layer.load(2);
        $.post('', {type: 'pastes',path:path,copy:copy}, function(data, textStatus, xhr) {
        	layer.closeAll('loading');
            layer.msg(data.msg);
        });
    }

        /* ! 宝塔文件上传组件 License  https://www.bt.cn  By 黄文良 <287962566@qq.com> */
        var bt_upload_file = {
            f: null,
            f_total: 0,
            f_path: null,
            split_size: 1024 * 1024 * 2*100,
            _files: [],
            _error: 0,
            _start_time: 0,
            _t_start_time: 0,
            collback_to: null,
            upload_url: '?type=uploadfile&path={:htmlspecialchars($viewpath)}',
            _loadT: null,
            open: function (path, is_exts, ps, collback_to) {
                bt_upload_file.f_path = path;
                user_agent = navigator.userAgent.toLowerCase();
                var btn_dir = '';
                var accept_ext = '';
                if (!is_exts) {
                    if (user_agent.indexOf('chrome') !== -1 || user_agent.indexOf('firefox') !== -1) {
                        btn_dir = '<input type="file" class="btn btn-sm btn-brown" id="dir_input" onchange="bt_upload_file.list(this.files)" style="display:none;"  multiple="true" autocomplete="off" multiple webkitdirectory /><button type="button"  id="opt" onclick="$(\'#dir_input\').click()" autocomplete="off" title="支持的浏览器: Chrome、Firefox、Edge、有极速模式的国产浏览器" class="btn btn-sm btn-info">选择目录</button>'
                    }
                } else {
                    accept_ext = 'accept="' + is_exts + '"'
                }
                var other_ps = '';
                if (ps) {
                    other_ps = ' --- <span style="color:red;">' + ps + '</span>'
                } else {
                    other_ps = ' --- 支持断点续传'
                }
                if (collback_to) {
                    bt_upload_file.collback_to = collback_to
                }
                bt_upload_file._loadT = layer.open({
                    type: 1,
                    title: '上传文件到[{$viewpath}]' + other_ps,
                    area: ['','90%'],
                    // shadeClose: false,
                    shift: 5,
                    closeBtn: 1,
                    maxmin: true,
                    content: '<div class="fileUploadDiv"><div class="row example-box"><div class="col-lg-6"><input type="file" id="file_input" onchange="bt_upload_file.list(this.files)"  multiple="true" autocomplete="off" ' + accept_ext + '  class="btn btn-sm btn-info"/><button type="button"  id="opt" onclick="$(\'#file_input\').click()" autocomplete="off" class="btn btn-sm btn-primary" >选择文件</button>' + btn_dir + '<span><button type="button" id="up" autocomplete="off" onclick="bt_upload_file.start(0)" class="btn btn-sm btn-success">开始上传</button><!--<button type="button" id="filesClose" autocomplete="off" onClick="layer.close(bt_upload_file._loadT)" class="btn btn-sm btn-danger">关闭</button>--></span></div><div class="col-md-6"><span id="totalProgress"></span></div></div></div><div class="table-responsive"><table  class="table"><thead><tr><th>文件名</th><th>大小</th><th>状态</th></tr></thead><tbody id="up_box"></tbody></table></div>'
                })
                // 强制全屏
                layer.full(bt_upload_file._loadT);
            },
            list: function (_files) {
                bt_upload_file._files = _files;
                var up_box = $("#up_box");
                $("#up_box").html('');
                var loadT = layer.msg('正在加载文件列表...', {
                    time: 0,
                    icon: 16,
                    shade: 0.3
                });
                for (var i = 0; i < _files.length; i += 1) {
                    var f_name = _files[i].name;
                    if (_files[i].webkitRelativePath) {
                        f_name = _files[i].webkitRelativePath
                    }
                    up_box.append('<tr class="offset-' + i + '"><td class="filename" title="上传到: ' + bt_upload_file.f_path + '/' + f_name + '">' + f_name + '</td><td class="filesize">' + bt_upload_file.to_size(_files[i].size) + '</td><td class="emmmm">等待上传</td></tr>')
                }
                layer.close(loadT)
            },
            to_size: function (a) {
                var d = [" B", " KB", " MB", " GB", " TB", " PB"];
                var e = 1024;
                for (var b = 0; b < d.length; b += 1) {
                    if (a < e) {
                        return (b === 0 ? a : a.toFixed(2)) + d[b]
                    }
                    a /= e
                }
            },
            start: function (i) {
                var len = bt_upload_file._files.length;
                if (len === 0) {
                    layer.msg('请选择文件!', {
                        icon: 2
                    });
                    return false
                }
                if (i === 0) {
                    bt_upload_file._t_start_time = new Date()
                }
                $("#filesClose,#up,#opt").attr("disabled", "disabled");
                var total_time = bt_upload_file.diff_time(bt_upload_file._t_start_time, new Date());
                $("#totalProgress").html('<p>已上传(' + i + '/' + len + '),' + total_time + '</p> <div class="progress"><div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="' + i + '" aria-valuemin="0" aria-valuemax="' + len + '" style="width: ' + GetPercent(i,len) + '"><span class="sr-only">' + i + '% Complete</span></div></div>');
                if (len <= i) {
                    $("#totalProgress").html('<p>上传完成(' + i + '/' + len + '), ' + total_time + '</p> <div class="progress"><div class="progress-bar progress-bar-success progress-bar-striped active" role="progressbar" aria-valuenow="' + i + '" aria-valuemin="0" aria-valuemax="' + len + '" style="width: ' + GetPercent(i,len) + '"><span class="sr-only">' + i + '% Complete</span></div></div>');
                    bt_upload_file._files = [];
                    $("#filesClose,#up,#opt").removeAttr("disabled");
                    if (bt_upload_file.collback_to) {
                        bt_upload_file.collback_to(bt_upload_file.f_path)
                    }
                    return false
                }
                if (i > 10) {
                    $("#up_box").scrollTop(35 * (i - 10) + 50)
                }
                bt_upload_file._start_time = new Date();
                bt_upload_file._error = 0;
                bt_upload_file.f = bt_upload_file._files[i];
                bt_upload_file.f_total = Math.ceil(bt_upload_file.f.size / bt_upload_file.split_size);
                bt_upload_file.upload(0, i)
            },
            upload: function (start, i) {
                var end = Math.min(bt_upload_file.f.size, start + bt_upload_file.split_size);
                var len = bt_upload_file._files.length;
                var f_path = bt_upload_file.f_path;
                if (bt_upload_file.f.webkitRelativePath) {
                    f_path = bt_upload_file.f_path + '/' + bt_upload_file.f.webkitRelativePath.replace('/' + bt_upload_file.f.name, '')
                }
                var form = new FormData();
                form.append("f_path", '{$viewpath}');
                form.append("f_name", bt_upload_file.f.name);
                form.append("f_size", bt_upload_file.f.size);
                form.append("f_start", start);
                form.append("blob", bt_upload_file.f.slice(start, end));
                form.append("m", "coll_upload");
                form.append("f", "upload");
                form.append("type", "uploadfile");
                $.ajax({
                    url: bt_upload_file.upload_url,
                    type: "POST",
                    data: form,
                    async: true,
                    processData: false,
                    contentType: false,
                    success: function (data) {
                        if (typeof (data) === "number") {
                            var progress = parseInt(data / bt_upload_file.f.size * 100);
                            var total_time = bt_upload_file.diff_time(bt_upload_file._t_start_time, new Date());
                            $("#totalProgress").html('<p>已上传(' + i + '/' + len + '),' + total_time + '</p> <div class="progress"><div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="' + i + '" aria-valuemin="0" aria-valuemax="' + len + '" style="width: ' + GetPercent(i,len) + '"><span class="sr-only">' + i + '% Complete</span></div></div>');
                            $("#up_box tr .emmmm")[i].outerHTML = '<td class="emmmm" style="color:green;">上传进度:' + progress + '%</td>';
                            $("#up_box tr .filesize")[i].outerHTML = '<td class="filesize">' + bt_upload_file.to_size(data) + '/' + bt_upload_file.to_size(bt_upload_file.f.size) + '</td>';
                            $("#up_box tr .emmmm")[i].focus();
                            bt_upload_file.upload(data, i)
                        } else {
                            if (data.code==1) {
                                var f_time = bt_upload_file.diff_time(bt_upload_file._start_time, new Date());
                                $("#up_box tr .emmmm")[i].outerHTML = '<td class="emmmm" style="color:green;">已完成(' + f_time + ')</td>';
                                $("#up_box tr .filesize")[i].outerHTML = '<td class="filesize">' + bt_upload_file.to_size(bt_upload_file.f.size) + '/' + bt_upload_file.to_size(bt_upload_file.f.size) + '</td>'
                            } else {
                                $("#up_box tr .emmmm")[i].outerHTML = '<td class="emmmm" style="color:red;">' + data.msg + '</td>'
                            }
                            bt_upload_file.start(i + 1)
                        }
                    },
                    error: function (e) {
                        if (bt_upload_file._error > 5) {
                            $("#up_box li .emmmm")[i].outerHTML = '<td class="emmmm" style="color:red;">上传失败</td>';
                            bt_upload_file.start(i + 1);
                            return
                        }
                        bt_upload_file._error += 1;
                        bt_upload_file.upload(start, i)
                    }
                })
            },
            diff_time: function (start_date, end_date) {
                var diff = end_date.getTime() - start_date.getTime();
                var minutes = Math.floor(diff / (60 * 1000));
                var leave3 = diff % (60 * 1000);
                var seconds = (leave3 / 1000).toFixed(2);
                var result = seconds + '秒';
                if (minutes > 0) {
                    result = minutes + "分" + result
                }
                return result
            }
        };
        
        
        //普通上传
        function scs(){
                var file = $('#zunfile').get(0).files[0]; //获取上传的文件  
                var fileSize = file.size;           //获取上传的文件大小  
                var maxSize = {$php_upload_max?$php_upload_max:'0'};              //最大上传(字节)  
                if(parseInt(fileSize) >= parseInt(maxSize)){  
                  max = bytes2mb({$php_upload_max});
                  parent.alert('上传的文件不能超过'+max+'M');  
                  return false;  
              }else{
                  layer.msg('正在上传');
                  
                  var data = new FormData($('#btyUploadFile')[0]);
                  $.ajax({
                    url: '?type=uploadfile&path={:htmlspecialchars($viewpath)}',   
                    type: 'POST',    
                    data: data,    
                    dataType: 'JSON', 
                    processData: false,    
                    contentType: false,
                    xhr: function(){
                      var xhr = $.ajaxSettings.xhr();
                      if(onprogress && xhr.upload) {
                       xhr.upload.addEventListener("progress" , onprogress, false);
                       return xhr;
                   }
               }
           }).done(function(ret){
            
            EchoMsg(ret.msg);
        });
           return false;  
        }    
    }
    function onprogress(evt){
        var loaded = evt.loaded;     //已经上传大小情况 
        var tot = evt.total;      //附件总大小 
        var per = Math.floor(100*loaded/tot);  //已经上传的百分比 
        layer.msg(per+'%');

    }
    //文件编辑
    function editFile(file,fileType){
        if(!file){
            layer.msg('请选择文件');
            return false;
        }
        randMath = randomNum(1111,9999);
        layer.msg('获取中……');
        $.post('', {file:file,type:'getfile'}, function(data, textStatus, xhr) {
            if(data.code==1){
                var u = ["utf-8", "GBK", "GB2312", "BIG5"];
                var n = "";
                var m = "";
                var o = "";
                var t = "";
                for(var p = 0; p < u.length; p++) {
                    m = data.encoding == u[p] ? "selected" : "";
                    n += '<option value="' + u[p] + '" ' + m + ">" + u[p] + "</option>"
                }
                content = '<form class="bt-form pd20 pb70" id="codemirror'+randMath+'"><div class="container-fluid"><p style="color:red;margin-bottom:10px;width: 70%;">提示：Ctrl+F 搜索关键字，Ctrl+G 查找下一个，Ctrl+S 保存，Ctrl+Shift+R 查找替换!<select class="bt-input-text hidden" name="encoding" style="width: 74px;position: absolute;right: 19px;height: 22px;z-index: 9999;border-radius: 0;">' + n + '</select></p><textarea id="textBody'+randMath+'" style="width: 100%; margin: 0px auto; line-height: 1.8; position: relative; top: 10px; height: 126.8px; display: none;" value=""/></div></form>';
                //content = '<pre style="width:100%;height:100%;" file="'+file+'"><code  class="php">'+data.data+'</code></pre>';
                var index = layer.open({
                  type: 1
                  ,title: '在线编辑'+file
                  ,shade: 0
                  ,area: ["90%", "90%"]
                  ,offset: 'auto'
                  ,maxmin: true
                  ,content: content
                  ,btn: ['保存', '关闭']
                  ,yes: function(){
                    $("#textBody"+randMath).text(t.getValue());
                    content = t.getValue();
                    encoding = $('#codemirror'+randMath+' select[name=encoding]').val();
                    layer.load();
                    saveFile(file,content,encoding);
                }
                ,btn2: function(){
                }
                ,zIndex: layer.zIndex //重点1
                // ,success: function(layero){
                //     layer.setTop(layero); //重点2
                // }
                });
                //layer.full(index);


                switch(fileType)
                {
                    case "html":
                    var mixedMode = {name: "htmlmixed",scriptTypes: [{matches: /\/x-handlebars-template|\/x-mustache/i,mode: null}, {matches: /(text|application)\/(x-)?vb(a|script)/i,mode: "vbscript"}]};
                    doctype = mixedMode;
                    break;
                    case "htm":
                    var mixedMode = {name: "htmlmixed",scriptTypes: [{matches: /\/x-handlebars-template|\/x-mustache/i,mode: null},{matches: /(text|application)\/(x-)?vb(a|script)/i,mode: "vbscript"}]};
                    doctype = mixedMode;
                    break;
                    case "js":
                    doctype = "text/javascript";
                    break;
                    case "json":
                    doctype = "application/ld+json";
                    break;
                    case "css":
                    doctype = "text/css";
                    break;
                    case "php":
                    doctype = "application/x-httpd-php";
                    break;
                    case "tpl":
                    doctype = "application/x-httpd-php";
                    break;
                    case "xml":
                    doctype = "application/xml";
                    break;
                    case "sql":
                    doctype = "text/x-sql";
                    break;
                    case "conf":
                    doctype = "text/x-nginx-conf";
                    break;
                    default:
                    var mixedMode = {name: "htmlmixed",scriptTypes: [{matches: /\/x-handlebars-template|\/x-mustache/i,mode: null}, {matches: /(text|application)\/(x-)?vb(a|script)/i,mode: "vbscript"}]};
                    doctype = mixedMode;
                    break;
                }
                //$("#textBody").text(data.data);
                var q = $(window).height() * 0.9;
                $("#textBody"+randMath).height(q - 160);
                var t = CodeMirror.fromTextArea(document.getElementById("textBody"+randMath), {
                    extraKeys: {
                        "Ctrl-F": "findPersistent",
                        "Ctrl-H": "replaceAll",
                        "Ctrl-S": function() {
                            $("#textBody"+randMath).text(t.getValue());
                            content = t.getValue();
                            encoding = $('#codemirror'+randMath+' select[name=encoding]').val();
                            layer.load();
                            saveFile(file,content,encoding);
                        }
                    },
                    lineNumbers: true,
                    //mode: 'application/x-httpd-php',
                    //styleActiveLine: true,
                    matchBrackets: true,
                    indentUnit: 4,
                    indentWithTabs: true,
                    matchtags: true,
                    autoMatchParens: true
            
                    //readOnly:true
                });
                //console.log(t.getValue());
                
                t.setSize("auto", q - 150);
                setTimeout(function(){
                    $("#textBody"+randMath).text(data.data);
                    t.setValue(data.data)
                },500);
                t.setOption("theme", 'default');
                t.focus();
            }else{
                EchoMsg(data.msg);
            }
            
        });
    }
    // 保存文件
    function saveFile(file,content,encoding){
        if(!file){
            layer.msg('请选择文件');
            return false;
        }
        
        $.post('', {file:file,type:'savefile',content:content,encoding:encoding}, function(data, textStatus, xhr) {
            
            layer.closeAll('loading');
            layer.msg(data.msg, {time: 2000, icon:6});
        });
    }
    
    //生成从minNum到maxNum的随机数
    function randomNum(minNum,maxNum){ 
        switch(arguments.length){ 
            case 1: 
            return parseInt(Math.random()*minNum+10); 
            break; 
            case 2: 
            return parseInt(Math.random()*(maxNum-minNum+1)+minNum,10);
            break; 
            default: 
            return 0; 
            break; 
        } 
    }
    function bytes2mb(bytes)
    {
        return Math.round(bytes / 1024 / 1024, 2);
    }
    //新建文件夹
    function newdir(){
        path = '{$viewpath}';
        layer.prompt({title: '新建文件夹', formType: 3}, function(text, index){
            layer.close(index);
            
            $.post('', {type:'newdir',path: path,newdir:text}, function(data, textStatus, xhr) {
                
                EchoMsg(data.msg);
            });
        });
    }
    //新建文件
    function newfile(){
        path = '{$viewpath}';
        layer.prompt({title: '新建文件', formType: 3}, function(text, index){
            layer.close(index);
            
            $.post('', {type:'newfile',path: path,newfile:text}, function(data, textStatus, xhr) {
                
                EchoMsg(data.msg);
            });
        });
    }
    //分片上传要用到的js
    function UploadFiles() {

        var path = '{$viewpath}';
        bt_upload_file.open(path, null, null, function (path) {
        });
        return;
    }
    // 百分比计算
    function GetPercent(num, total) {
        num = parseFloat(num);
        total = parseFloat(total);
        if (isNaN(num) || isNaN(total)) {
            return "-";
        }
        return total <= 0 ? "0%" : (Math.round(num / total * 10000) / 100.00)+"%";
    }
    $("#check-all").change(function () {
        if($("input[type='checkbox']").prop('checked')){
            $('.batchAction').show();
        }else{
            $('.batchAction').hide();
        }
    });
    var chk = $('input[type="checkbox"]');
    chk.click(function(){
        var len = $('input[type="checkbox"]').filter(":checked").length;
        if(len>=2){
            $('.batchAction').show();
        }else{
            $('.batchAction').hide();
        }
    });
    function batchAction(batchType){
        path = '{$viewpath}';
        data = batch();
        
        var msg = '标题';
        switch(batchType){
            case 'del':
            msg = '确定删除？';
            break;
            case 'CutFile':
            msg = '剪切？';
            break;
            case 'CutFiles':
            msg = '复制？';
            break;
            default:
            msg = '?????????'
            break;
        }
        layer.confirm(msg, {
              btn: ['确定','取消']
            }, function(){
                
                $.post('', {type:'batch',path: path,data:data,batch:batchType}, function(data, textStatus, xhr) {
                    
                    if(batchType=='CutFile'||batchType=='CutFiles'){
                        layer.msg(data.msg);
                        // setTimeout("location.reload();", 1000);
                    }else{
                        EchoMsg(data.msg);
                    }
                    
                    
                });
            }, function(index){
            layer.close(index);
        });
        
    }
    //批量操作
    function batch(){
        var arry = new Array();
        $('input[name="ids[]"]:checked').each(function(index, element) {
            arry.push($(this).val());
        });
        var arrystr = arry.join(',');
        if(!arrystr){
            layer.msg('没有勾选内容');
            return false;
        }
        return arrystr;
    }
    function getBatchFileName(){
        var a ='';
        $('input[name="ids[]"]:checked').each(function(index, element) {
            a = $(this).val();
        });
        if(!a){
            layer.msg('没有勾选内容');
            return false;
        }
        return a;
    }
    // 执行粘贴批量复制/剪切的任务
    function BatchPaste(type){
        path = '{$viewpath}';
        
        $.post('', {type: 'BatchPaste',path:path,ty:type}, function(data) {
            
                EchoMsg(data.msg)
        });
    }
    function openDown(){
        var strVar = "";
        path = '{$viewpath}';
        strVar += "<form id=\"DownloadFile\"><div class=\"bt-form pd20 pb70 row\" style=\"padding:20px;\">\n";
        strVar += " <div class=\"line unzipdiv form-group\">\n";
        strVar += "<input type=\"hidden\" name=\"type\" value=\"DownloadFile\" class=\"form-control\"/>\n";
        strVar += "     <label class=\"tname\">URL地址<\/label><input type=\"text\" class=\"bt-input-text form-control\" id=\"mUrl\" name=\"mUrl\"  placeholder=\"URL地址\" >\n";
        strVar += "     <label class=\"tname\">下载到<\/label><input type=\"text\" class=\"bt-input-text form-control\" name=\"path\" value=\""+path+"\" placeholder=\"下载到目录路径\" >\n";
        strVar += " <\/div>\n";
        strVar += " <div class=\"line form-group\">\n";
        strVar += "     <label class=\"tname\">文件名<\/label><input type=\"text\" class=\"bt-input-text form-control\" id=\"dfilename\" name=\"dfilename\" placeholder=\"文件名\" >\n";
        strVar += " <\/div>\n";
        strVar += " <div class=\"bt-form-submit-btn\" style=\"text-align:right;margin-top:10px;\">\n";
        strVar += "     <button type=\"button\" class=\"btn btn-danger btn-sm btn-title\" onclick=\"layer.closeAll()\">关闭<\/button><button type=\"button\" id=\"ReNameBtn\" class=\"btn btn-success btn-sm btn-title\" onclick=\"DownloadFile()\">下载<\/button>\n";
        strVar += " <\/div>\n";
        strVar += "<\/div><\/form>\n";

        layer.open({
            type: 1,
            shift: 5,
            closeBtn: 2,
            area: ['',"90%"],
            title: '远程下载',
            content: strVar
        });
        $("#mUrl").change(function () {
            durl = $(this).val();
            console.log(durl);
            tmp = durl.split('/')
            $("#dfilename").val(tmp[tmp.length-1])
        });
    }
    // 远程下载文件
    function DownloadFile(){
        data = $('#DownloadFile').serialize();
        mUrl = $('#mUrl').val();
        dfilename = $('#dfilename').val();
        if(mUrl==''){
            lay.msg('下载地址不能为空');
            return false;
        }
        if(dfilename==''){
            lay.msg('文件名不能为空');
            return false;
        }
        $.post('', data, function(data, textStatus, xhr) {
            EchoMsg(data.msg);
        });
    }
</script>
{/block}
